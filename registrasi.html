<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Register - Vault</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="css/registrasi.css" />
    <style>
      .info-box {
        font-size: 0.85em;
        background: #f0f0f0;
        padding: 10px;
        margin-top: 5px;
        border-radius: 5px;
        display: none;
        color: #333;
      }
      .error-message {
        font-size: 0.85em;
        color: red;
        margin-top: 5px;
        display: none;
      }
      .valid {
        color: green;
      }
    </style>
  </head>
  <body>
    <div class="auth-container">
      <div class="auth-box">
        <h2 class="auth-title">Create Account</h2>
        <form id="registerForm">
          <div class="form-group">
            <label for="username"><i class="fas fa-user"></i> Username</label>
            <input
              type="text"
              id="username"
              name="username"
              placeholder="Enter your username"
              required
              autocomplete="off"
            />
          </div>
          <div class="form-group">
            <label for="email"><i class="fas fa-envelope"></i> Email</label>
            <input
              type="email"
              id="email"
              name="email"
              placeholder="Enter your email"
              required
              autocomplete="off"
            />
          </div>
          <div class="form-group">
            <label for="password"><i class="fas fa-lock"></i> Password</label>
            <div class="password-wrapper">
              <input
                type="password"
                id="password"
                name="password"
                placeholder="Enter your password"
                required
                autocomplete="off"
              />
              <i class="fas fa-eye toggle-password" data-target="password"></i>
            </div>
            <div id="passwordRules" class="info-box">
              Password must contain:
              <ul>
                <li id="rule-length">Minimum 4 characters</li>
                <li id="rule-upper">At least one uppercase letter</li>
                <li id="rule-lower">At least one lowercase letter</li>
                <li id="rule-number">At least one number</li>
                <li id="rule-symbol">At least one symbol (!@#$...)</li>
              </ul>
            </div>
          </div>
          <div class="form-group">
            <label for="confirmPassword"
              ><i class="fas fa-lock"></i> Confirm Password</label
            >
            <div class="password-wrapper">
              <input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                placeholder="Confirm your password"
                required
                autocomplete="off"
              />
              <i
                class="fas fa-eye toggle-password"
                data-target="confirmPassword"
              ></i>
            </div>
            <div id="confirmError" class="error-message">
              Passwords do not match
            </div>
          </div>
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <span id="buttonText">Register</span>
            <i
              class="fas fa-spinner fa-spin"
              id="loginSpinner"
              style="display: none; margin-left: 10px"
            ></i>
          </button>
        </form>
        <p class="redirect-text">
          Already have an account? <a href="loginPage.html">Login</a>
        </p>
      </div>
      <div class="auth-illustration">
        <img src="img/registrasi.svg" alt="Secure Vault Illustration" />
      </div>
    </div>

    <script>
      const passwordInput = document.getElementById("password");
      const confirmInput = document.getElementById("confirmPassword");
      const usernameInput = document.getElementById("username");
      const emailInput = document.getElementById("email");
      const passwordRules = document.getElementById("passwordRules");
      const confirmError = document.getElementById("confirmError");

      function hidePasswordRules() {
        passwordRules.style.display = "none";
      }

      // Show rules only when password is focused
      passwordInput.addEventListener("focus", () => {
        passwordRules.style.display = "block";
      });

      // Hide rules if focus moves to other inputs
      [usernameInput, emailInput, confirmInput].forEach((input) => {
        input.addEventListener("focus", hidePasswordRules);
      });

      passwordInput.addEventListener("input", () => {
        const val = passwordInput.value;
        document
          .getElementById("rule-length")
          .classList.toggle("valid", val.length >= 8);
        document
          .getElementById("rule-upper")
          .classList.toggle("valid", /[A-Z]/.test(val));
        document
          .getElementById("rule-lower")
          .classList.toggle("valid", /[a-z]/.test(val));
        document
          .getElementById("rule-number")
          .classList.toggle("valid", /[0-9]/.test(val));
        document
          .getElementById("rule-symbol")
          .classList.toggle("valid", /[^A-Za-z0-9]/.test(val));
      });

      confirmInput.addEventListener("input", () => {
        if (confirmInput.value !== passwordInput.value) {
          confirmError.style.display = "block";
        } else {
          confirmError.style.display = "none";
        }
      });

      // Password toggle eye icon remains unchanged
      document.querySelectorAll(".toggle-password").forEach((icon) => {
        icon.addEventListener("click", () => {
          const target = document.getElementById(icon.dataset.target);
          const type = target.type === "password" ? "text" : "password";
          target.type = type;
          icon.classList.toggle("fa-eye");
          icon.classList.toggle("fa-eye-slash");
        });
      });

      document
        .getElementById("registerForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          if (confirmInput.value !== passwordInput.value) {
            confirmError.style.display = "block";
            return;
          }

          const spinner = document.getElementById("loginSpinner");
          const submitBtn = document.getElementById("submitBtn");
          const buttonText = document.getElementById("buttonText");

          spinner.style.display = "inline-block";
          submitBtn.disabled = true;
          buttonText.textContent = "Sending...";

           const formData = new FormData(this);

          fetch("php/registrasi.php", {
            method: "POST",
            body: formData,
          })
            .then((res) => res.json())
            .then((data) => {
              alert(data.message);

              if (data.success) {
                document.getElementById("registerForm").reset();
                window.location.href = "loginPage.html";
              }
            })
            .catch((err) => {
              alert("Registration failed. Please try again.");
              console.error(err);
            })
            .finally(() => {
              spinner.style.display = "none";
              submitBtn.disabled = false;
              buttonText.textContent = "Register";
            });
        });
    </script>
  </body>
</html>
